# 云同步 UI 更新说明

## 📝 更新内容

### 问题
之前的云同步设置只要求输入"设备名称",用户无法配置服务器地址,导致:
- ❌ 无法连接到自己部署的 Workers
- ❌ 无法切换不同的服务器环境
- ❌ 用户体验不够灵活

### 解决方案

更新了云同步设置界面,现在支持:

#### 1. **服务器地址配置** ✅
- 用户可以输入自己的 Workers API 地址
- 默认值从环境变量 `VITE_API_BASE_URL` 读取
- 支持本地开发和生产环境

#### 2. **设备名称配置** ✅
- 用于在多设备管理中识别设备
- 例如: "我的 MacBook Pro", "办公室电脑"

#### 3. **高级选项** ✅
- 预留了高级选项按钮(▶ 高级选项)
- 未来可以添加更多配置项

## 🎨 新界面

### 未登录状态

```
☁️ 云同步

┌─────────────────────────────────────┐
│ 服务器地址              ▶ 高级选项   │
│ ┌─────────────────────────────────┐ │
│ │ https://your-worker.workers.dev │ │
│ └─────────────────────────────────┘ │
│ Workers API 地址,默认使用本地开发服务器│
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 设备名称                             │
│ ┌─────────────────────────────────┐ │
│ │ 例如: 我的 MacBook Pro          │ │
│ └─────────────────────────────────┘ │
│ 用于在多设备管理中识别此设备          │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│      🚀 登录并启用云同步             │
└─────────────────────────────────────┘
```

### 已登录状态

```
☁️ 云同步

┌─────────────────────────────────────┐
│ 🌐 服务器: http://localhost:8787    │
│ 👤 用户ID: 12345678...              │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ ✅ 已启用                    [开关]  │
│ 自动同步到云端                       │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 最后同步: ✅ 5 分钟前                │
│ 资产数量: 150 / 1000                │
│ 存储空间: 45.2 MB / 500.0 MB        │
└─────────────────────────────────────┘

┌──────────────┬──────────────────────┐
│ 🔄 立即同步  │  🚪 退出登录          │
└──────────────┴──────────────────────┘
```

## 🔧 技术实现

### 1. API Client 更新

添加了 `setBaseUrl()` 和 `getBaseUrl()` 方法:

```typescript
// lib/api/client.ts
class ApiClient {
  setBaseUrl(url: string) {
    this.baseUrl = url;
  }
  
  getBaseUrl(): string {
    return this.baseUrl;
  }
}
```

### 2. 登录流程更新

```typescript
// 登录前设置 API 地址
const { apiClient } = await import('../../lib/api');
apiClient.setBaseUrl(apiUrl.trim());

// 然后执行登录
await login(deviceInfo);
```

### 3. 状态管理

```typescript
const [apiUrl, setApiUrl] = useState(
  import.meta.env.VITE_API_BASE_URL || 'http://localhost:8787'
);
```

## 📋 使用流程

### 开发环境

1. 启动本地 Workers:
   ```bash
   cd apps/workers
   npm run dev
   ```

2. 打开应用设置
3. 服务器地址默认为: `http://localhost:8787`
4. 输入设备名称
5. 点击"登录并启用云同步"

### 生产环境

1. 部署 Workers 到 Cloudflare
2. 获取 Workers URL: `https://your-worker.your-subdomain.workers.dev`
3. 打开应用设置
4. 输入服务器地址: `https://your-worker.your-subdomain.workers.dev`
5. 输入设备名称
6. 点击"登录并启用云同步"

## 🔐 安全说明

### 认证方式

当前使用的是**设备注册模式**:

1. 用户输入设备名称
2. 客户端生成设备ID (UUID)
3. 调用 `/auth/device-register` API
4. 后端创建用户和设备记录
5. 返回 JWT Token (有效期 30 天)
6. Token 存储在 localStorage

### 为什么不需要 API Token?

设计采用了**自动注册**模式:
- ✅ 首次使用自动创建账户
- ✅ 每个设备独立注册
- ✅ JWT Token 自动管理
- ✅ 适合个人使用场景

### 如果需要 API Token 认证

如果你想使用传统的 API Token 认证,可以:

1. 在 Workers 中添加 API Token 验证
2. 在登录界面添加 Token 输入框
3. 修改认证流程使用 Token

## 🎯 未来增强

### 高级选项可以包括:

1. **代理设置**
   - HTTP/HTTPS 代理
   - SOCKS5 代理

2. **同步设置**
   - 同步频率
   - 选择同步内容
   - 冲突处理策略

3. **网络设置**
   - 请求超时
   - 重试次数
   - 并发限制

4. **安全设置**
   - 端到端加密
   - 自定义加密密钥
   - 双因素认证

## 📚 相关文档

- [CLOUD_SYNC_DESIGN_v2.md](./CLOUD_SYNC_DESIGN_v2.md) - 云同步设计
- [INTEGRATION_COMPLETE.md](./INTEGRATION_COMPLETE.md) - 集成完成报告
- [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - 部署指南

## ❓ 常见问题

**Q: 为什么要输入设备名称?**
A: 设备名称用于在多设备管理中识别不同的设备,方便你知道哪些设备在使用云同步。

**Q: 可以使用多个服务器吗?**
A: 目前一次只能连接一个服务器。如果需要切换服务器,需要先退出登录,然后输入新的服务器地址重新登录。

**Q: 服务器地址填错了怎么办?**
A: 会显示"网络错误: Load failed"。检查地址是否正确,Workers 是否正常运行。

**Q: 数据安全吗?**
A: 数据存储在 Cloudflare 的 D1 数据库和 R2 存储中,使用 JWT Token 认证,每个用户的数据完全隔离。

## ✨ 总结

更新后的云同步设置更加灵活和专业:

- ✅ 支持自定义服务器地址
- ✅ 清晰的表单布局
- ✅ 详细的提示信息
- ✅ 显示当前连接的服务器
- ✅ 更好的用户体验

现在用户可以轻松连接到自己部署的 Workers 服务了!
